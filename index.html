<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Tài Liệu</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
        .modal-table-header { font-size: 0.65rem; } 
        .input-mini { font-size: 0.75rem; padding: 2px 4px; height: 24px; line-height: 1; }
        input::-webkit-calendar-picker-indicator { opacity: 0.8; transform: scale(0.9); cursor: pointer; }

        .editable-cell { cursor: text; padding: 4px; border-radius: 4px; border: 1px solid transparent; transition: all 0.2s; min-height: 24px; display: flex; align-items: center; }
        .editing-mode .editable-cell:hover { background-color: #f0f9ff; border-color: #bae6fd; cursor: pointer; }
        .inline-input-active { width: 100%; font-size: 0.75rem; padding: 2px; border: 1px solid #3b82f6; border-radius: 2px; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        .sortable-header { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        .sortable-header:hover { background-color: #e5e7eb; }
        .btn-upload:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <datalist id="listFields"></datalist>
    <datalist id="listUnits"></datalist>
    <datalist id="listIssuers"></datalist>

    <input type="file" id="driveFileInput" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx">

    <div class="flex-none flex flex-row border-b shadow-sm z-30 bg-white">
        <div class="flex-none bg-white flex items-center justify-center border-r" style="width: 130px; min-height: 100px;">
            <img src="https://pvgaslpg.com.vn/uploads/LPG%20xanh%20animation.gif" alt="Logo PVGAS" style="width: 100px; height: 100px; object-fit: contain;">
        </div>

        <div class="flex-grow flex flex-col min-w-0">
            <header class="bg-blue-900 text-white flex-none">
                <div class="w-full px-4 py-3 flex justify-between items-center h-[50px]">
                    <h1 class="text-lg font-bold uppercase tracking-wide flex items-center truncate">
                        <i class="fa-solid fa-folder-tree mr-2"></i> Quản Lý Tài Liệu
                    </h1>
                    <div id="userInfo" class="text-xs italic text-blue-200 hidden whitespace-nowrap">
                        <i class="fa-solid fa-user-check mr-1"></i> Đã đăng nhập
                    </div>
                </div>
            </header>

            <div class="p-3 flex-grow flex items-end">
                <div class="w-full grid grid-cols-1 md:grid-cols-12 gap-3">
                    <div class="md:col-span-4 relative">
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">Từ khóa</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                                <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                            </span>
                            <input type="text" id="searchInput" 
                                class="w-full pl-9 pr-3 py-1.5 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" 
                                placeholder="Tìm kiếm...">
                        </div>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">Lĩnh vực</label>
                        <select id="fieldFilter" class="w-full p-1.5 border rounded bg-gray-50 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">Đơn vị sử dụng</label>
                        <select id="unitFilter" class="w-full p-1.5 border rounded bg-gray-50 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 flex items-center h-full pb-2">
                        <label class="inline-flex items-center cursor-pointer select-none" title="Tích chọn: Chỉ hiển thị tài liệu của ĐÚNG đơn vị này (Bỏ qua phân cấp)">
                            <input type="checkbox" id="strictUnitFilter" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" onchange="handleFilterChange()">
                            <span class="ml-2 text-xs font-bold text-gray-500 tracking-wider">Chỉ lọc chính xác ĐV</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <main class="w-full px-4 py-4 flex-grow flex flex-col h-full overflow-hidden relative">
        <div class="flex items-center mb-3 flex-none h-10">
            <div id="paginationContainer" class="flex items-center space-x-2 select-none"></div>

            <div class="flex items-center gap-2 ml-auto">
                <div id="editTools" class="hidden flex items-center gap-2">
                    <label class="cursor-pointer bg-green-700 hover:bg-green-800 text-white px-3 py-1 rounded text-sm font-bold shadow transition flex items-center border border-green-600 h-8 whitespace-nowrap" title="Nhập từ Excel">
                        <i class="fa-solid fa-file-excel mr-1"></i> Excel
                        <input type="file" id="excelFileInput" accept=".xlsx, .xls" class="hidden">
                    </label>

                    <button onclick="openHierarchyModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm font-bold shadow transition h-8 whitespace-nowrap">
                        <i class="fa-solid fa-sitemap mr-1"></i> Phân cấp
                    </button>

                    <button id="addEditBtn" onclick="handleAddEditAction()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-bold shadow transition min-w-[80px] h-8 whitespace-nowrap">
                        <i class="fa-solid fa-plus mr-1"></i> Thêm
                    </button>

                    <button onclick="deleteSelected()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-bold shadow transition h-8 whitespace-nowrap">
                        <i class="fa-solid fa-trash mr-1"></i> Xóa
                    </button>
                </div>

                <button id="toggleEditBtn" onclick="handleEditButtonClick()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded text-sm font-bold shadow transition w-36 text-center h-8 whitespace-nowrap">
                    <i class="fa-solid fa-pen-to-square mr-1"></i> Chỉnh sửa
                </button>
            </div>
        </div>

        <div id="notification" class="hidden mb-3 p-3 rounded text-sm font-medium flex-none text-center shadow-sm"></div>

        <div class="bg-white rounded-lg shadow border border-gray-200 flex-grow flex flex-col overflow-hidden">
            <div class="overflow-auto flex-grow relative">
                <table class="min-w-full leading-normal table-fixed">
                    <thead class="sticky top-0 z-10 bg-gray-100 text-blue-700 text-xs font-bold tracking-wider border-b-2 border-gray-300">
                        <tr>
                            <th id="colCheckbox" class="hidden px-2 py-3 w-10 text-center">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th class="px-2 py-3 w-28 text-left sortable-header" ondblclick="sortData('code')" title="Sắp xếp">Mã hiệu <i id="sort-code" class="fa-solid fa-sort text-gray-300 ml-1"></i></th>
                            <th class="px-2 py-3 text-left sortable-header" ondblclick="sortData('name')" title="Sắp xếp">Tên tài liệu, Quy trình <i id="sort-name" class="fa-solid fa-sort text-gray-300 ml-1"></i></th>
                            <th class="px-2 py-3 w-20 text-center sortable-header" ondblclick="sortData('issuer')" title="Sắp xếp">CQBH <i id="sort-issuer" class="fa-solid fa-sort text-gray-300 ml-1"></i></th>
                            <th class="px-2 py-3 w-32 text-left sortable-header" ondblclick="sortData('field')">Lĩnh vực <i id="sort-field" class="fa-solid fa-sort text-gray-300 ml-1"></i></th>
                            <th class="px-2 py-3 w-32 text-left sortable-header" ondblclick="sortData('unit')">ĐV sử dụng <i id="sort-unit" class="fa-solid fa-sort text-gray-300 ml-1"></i></th>
                            <th class="px-2 py-3 w-24 text-center sortable-header" ondblclick="sortData('date')">Ngày BH <i id="sort-date" class="fa-solid fa-sort text-gray-300 ml-1"></i></th>
                            <th class="px-2 py-3 w-12 text-center text-gray-600">Rev.</th>
                            <th class="px-2 py-3 w-16 text-center">Scan</th>
                            <th class="px-2 py-3 w-16 text-center">Mềm</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div class="px-4 py-2 bg-gray-50 border-t flex-none flex justify-between items-center">
                <span class="text-xs font-semibold text-gray-600" id="recordCount">0 bản ghi</span>
            </div>
        </div>
    </main>

    <div id="loginModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-60"></div>
        <div class="modal-container bg-white w-96 mx-auto rounded shadow-lg z-50">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3"><p class="text-xl font-bold text-blue-900">Đăng nhập</p><div class="cursor-pointer z-50" onclick="closeLoginModal()"><i class="fa-solid fa-times text-gray-500"></i></div></div>
                <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">Tài khoản</label><div class="flex items-center border rounded w-full py-2 px-3 bg-gray-100"><i class="fa-solid fa-user mr-2 text-gray-400"></i><span>****@pvgas.com</span></div></div>
                <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">Mật khẩu</label><input type="password" id="loginPassword" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Nhập mật khẩu..." onkeydown="if(event.key==='Enter') performLogin()"></div>
                <div class="flex justify-end pt-2"><button onclick="performLogin()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full">Xác thực</button></div>
            </div>
        </div>
    </div>

    <div id="dataModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-full max-w-[95%] mx-4 rounded shadow-lg z-50 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="modal-header flex justify-between items-center p-3 border-b bg-gray-50 flex-none"><h3 id="modalTitle" class="text-base font-bold text-gray-700">Thêm mới tài liệu</h3><div class="cursor-pointer" onclick="closeModal()"><i class="fa-solid fa-times text-gray-500 hover:text-red-500 text-lg"></i></div></div>
            <div class="modal-body p-2 overflow-y-auto bg-gray-50 flex-grow">
                <div class="bg-white border rounded shadow-sm overflow-x-auto"><table class="min-w-full divide-y divide-gray-200" id="modalTable"><thead class="bg-gray-100 text-gray-600 uppercase font-bold modal-table-header"><tr><th class="px-1 py-1 w-20">Mã hiệu</th><th class="px-1 py-1 min-w-[200px]">Tên tài liệu <span class="text-red-500">*</span></th><th class="px-1 py-1 w-20">CQBH</th><th class="px-1 py-1 w-20">Lĩnh vực</th><th class="px-1 py-1 w-20">Đơn vị</th><th class="px-1 py-1 w-24">Ngày BH</th><th class="px-1 py-1 w-10">Lần</th><th class="px-1 py-1 w-28">Link Scan</th><th class="px-1 py-1 w-28">Link Soft</th><th class="px-1 py-1 w-8"></th></tr></thead><tbody id="modalTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                <div class="mt-2" id="addMoreRowContainer"><button onclick="addNewRow()" class="flex items-center px-3 py-1 bg-green-100 text-green-700 hover:bg-green-200 rounded border border-green-300 text-xs font-bold transition"><i class="fa-solid fa-plus-circle mr-1"></i> Thêm dòng mới</button><span class="text-[10px] text-gray-500 ml-2 italic">Mẹo: Dùng phím Lên/Xuống để chuyển dòng.</span></div>
            </div>
            <div class="modal-footer flex justify-end p-3 border-t bg-white flex-none space-x-2"><button onclick="closeModal()" class="px-3 py-1.5 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 font-bold text-xs">Hủy bỏ</button><button onclick="handleModalSave()" id="modalSaveBtn" class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold text-xs shadow"><i class="fa-solid fa-save mr-1"></i> Lưu lại</button></div>
        </div>
    </div>

    <div id="hierarchyModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-full max-w-lg mx-4 rounded shadow-lg z-50 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="modal-header flex justify-between items-center p-3 border-b bg-gray-50 flex-none"><h3 class="text-base font-bold text-gray-700"><i class="fa-solid fa-sitemap mr-1"></i> Thiết lập Phân Cấp</h3><div class="cursor-pointer" onclick="closeHierarchyModal()"><i class="fa-solid fa-times text-gray-500 hover:text-red-500 text-lg"></i></div></div>
            <div class="modal-body p-4 overflow-y-auto bg-gray-50 flex-grow">
                <div class="bg-white p-3 rounded border mb-4"><h4 class="text-xs font-bold text-blue-800 uppercase mb-2">Thêm liên kết Mẹ - Con</h4><div class="grid grid-cols-2 gap-3 mb-2"><div><label class="block text-xs text-gray-500 mb-1">Đơn vị Mẹ</label><input type="text" id="hParent" list="listUnits" class="w-full border p-1.5 rounded text-sm focus:ring-1 focus:ring-blue-500" placeholder="Chọn mẹ..." onfocus="handleDatalistFocus(event)" onblur="handleDatalistBlur(event)"></div><div><label class="block text-xs text-gray-500 mb-1">Đơn vị Con</label><input type="text" id="hChild" list="listUnits" class="w-full border p-1.5 rounded text-sm focus:ring-1 focus:ring-blue-500" placeholder="Chọn con..." onfocus="handleDatalistFocus(event)" onblur="handleDatalistBlur(event)"></div></div><button onclick="addHierarchyLink()" class="w-full bg-blue-600 text-white text-xs font-bold py-1.5 rounded hover:bg-blue-700 transition">Thêm Liên Kết</button></div>
                <div class="bg-white p-3 rounded border"><h4 class="text-xs font-bold text-gray-700 uppercase mb-2 border-b pb-1">Cấu trúc hiện tại</h4><div id="hierarchyList" class="space-y-1 max-h-60 overflow-y-auto"></div></div>
            </div>
            <div class="modal-footer flex justify-end p-3 border-t bg-white flex-none"><button onclick="closeHierarchyModal()" class="px-3 py-1.5 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 font-bold text-xs">Đóng</button></div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBxfLtfKy9QQSxqboUD5T5MzkF58rtmKc0",
            authDomain: "quytrinh-e6c77.firebaseapp.com",
            databaseURL: "https://quytrinh-e6c77-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quytrinh-e6c77",
            storageBucket: "quytrinh-e6c77.firebasestorage.app",
            messagingSenderId: "437804230033",
            appId: "1:437804230033:web:8bbd5d5f6e77a0c379a630",
            measurementId: "G-7B7G474Q4M"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const COLLECTION_NAME = "documents";
        const SYSTEM_COLLECTION = "system";

        const CLIENT_ID = "588583798336-o4gjnfqaupmmdp8mi38o9m8r4n0bbghs.apps.googleusercontent.com";
        const API_KEY = ""; 
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = "https://www.googleapis.com/auth/drive.file";
        const FOLDER_ID = "1uyHJHfNFLIdPQbYu1uF4zliORCM6QK3P";

        let gapiInited = false, gisInited = false, tokenClient;
        let currentUploadContext = null;
        let allDocuments = [], filteredDocuments = [];
        let currentPage = 1, rowsPerPage = 20;
        let isEditMode = false, selectedIds = new Set(), currentModalMode = 'ADD';
        let unitHierarchy = {}, currentUser = null;
        let sortConfig = { column: null, direction: 'asc' };

        const els = {
            tableBody: document.getElementById('tableBody'),
            searchInput: document.getElementById('searchInput'),
            fieldFilter: document.getElementById('fieldFilter'),
            unitFilter: document.getElementById('unitFilter'),
            recordCount: document.getElementById('recordCount'),
            notification: document.getElementById('notification'),
            excelInput: document.getElementById('excelFileInput'),
            driveFileInput: document.getElementById('driveFileInput'),
            paginationContainer: document.getElementById('paginationContainer'),
            toggleEditBtn: document.getElementById('toggleEditBtn'),
            editTools: document.getElementById('editTools'),
            addEditBtn: document.getElementById('addEditBtn'),
            colCheckbox: document.getElementById('colCheckbox'),
            selectAll: document.getElementById('selectAll'),
            modal: document.getElementById('dataModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalTableBody: document.getElementById('modalTableBody'),
            modalSaveBtn: document.getElementById('modalSaveBtn'),
            addMoreRowContainer: document.getElementById('addMoreRowContainer'),
            listFields: document.getElementById('listFields'),
            listUnits: document.getElementById('listUnits'),
            listIssuers: document.getElementById('listIssuers'),
            hierarchyModal: document.getElementById('hierarchyModal'),
            hParent: document.getElementById('hParent'),
            hChild: document.getElementById('hChild'),
            hierarchyList: document.getElementById('hierarchyList'),
            loginModal: document.getElementById('loginModal'),
            loginPassword: document.getElementById('loginPassword'),
            userInfo: document.getElementById('userInfo')
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await auth.signOut();
            fetchDocuments();
            fetchHierarchy();
            els.searchInput.addEventListener('input', handleFilterChange);
            els.fieldFilter.addEventListener('change', handleFilterChange);
            els.unitFilter.addEventListener('change', handleFilterChange);
            els.excelInput.addEventListener('change', handleExcelUpload);
            els.driveFileInput.addEventListener('change', handleDriveFileSelected);
            setupKeyboardNavigation();
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if(user) els.userInfo.classList.remove('hidden');
                else { els.userInfo.classList.add('hidden'); if(isEditMode) toggleEditMode(false); }
            });
            gapi.load('client', initializeGapiClient);
            tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: () => {} });
            gisInited = true;
        });

        async function initializeGapiClient() { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); gapiInited = true; }

        function handleAddEditAction() { if (selectedIds.size > 0) openModal('EDIT'); else openModal('ADD'); }
        function updateAddEditButton() {
            const btn = els.addEditBtn;
            if (selectedIds.size > 0) {
                btn.innerHTML = '<i class="fa-solid fa-pen mr-1"></i> Sửa';
                btn.className = "bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm font-bold shadow transition min-w-[80px] h-8 whitespace-nowrap";
            } else {
                btn.innerHTML = '<i class="fa-solid fa-plus mr-1"></i> Thêm';
                btn.className = "bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-bold shadow transition min-w-[80px] h-8 whitespace-nowrap";
            }
        }

        function sortData(column) {
            if (sortConfig.column === column) sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            else { sortConfig.column = column; sortConfig.direction = 'asc'; }
            filteredDocuments.sort((a, b) => { let valA = a[column] || ''; let valB = b[column] || ''; if (column === 'date') { valA = new Date(valA).getTime() || 0; valB = new Date(valB).getTime() || 0; } else if (column === 'revision') { valA = parseInt(valA) || 0; valB = parseInt(valB) || 0; } else { valA = String(valA).toLowerCase(); valB = String(valB).toLowerCase(); } if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1; if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1; return 0; });
            document.querySelectorAll('.fa-sort, .fa-sort-up, .fa-sort-down').forEach(i => i.className = 'fa-solid fa-sort text-gray-300 ml-1');
            const activeIcon = document.getElementById(`sort-${column}`); if (activeIcon) activeIcon.className = sortConfig.direction === 'asc' ? 'fa-solid fa-sort-up text-blue-600 ml-1' : 'fa-solid fa-sort-down text-blue-600 ml-1';
            currentPage = 1; renderTable();
        }

        function handleEditButtonClick() { if (isEditMode) toggleEditMode(false); else { if (currentUser) toggleEditMode(true); else openLoginModal(); } }
        function openLoginModal() { document.body.classList.add('modal-active'); els.loginModal.classList.remove('opacity-0', 'pointer-events-none'); els.loginPassword.value = ''; els.loginPassword.focus(); }
        function closeLoginModal() { document.body.classList.remove('modal-active'); els.loginModal.classList.add('opacity-0', 'pointer-events-none'); }
        function performLogin() { const email = "tailieu@pvgas.com"; const password = els.loginPassword.value.trim(); if (!password) { showNotify("Vui lòng nhập mật khẩu!", "red"); return; } showNotify("Đang xác thực...", "blue"); auth.signInWithEmailAndPassword(email, password).then(() => { closeLoginModal(); showNotify("Đăng nhập thành công!", "green"); toggleEditMode(true); }).catch((error) => { showNotify("Mật khẩu không đúng!", "red"); }); }

        function fetchDocuments() {
            db.collection(COLLECTION_NAME).orderBy('date', 'desc').limit(200).onSnapshot((snapshot) => {
                allDocuments = []; snapshot.forEach((doc) => allDocuments.push({ id: doc.id, ...doc.data() }));
                const term = els.searchInput.value.toLowerCase();
                if(term) handleFilterChange(); else { filteredDocuments = [...allDocuments]; populateFilters(); updateDatalists(); currentPage = 1; renderTable(); }
            }, (error) => { console.error(error); showNotify("Lỗi kết nối CSDL!", "red"); });
        }
        function fetchHierarchy() {
            db.collection(SYSTEM_COLLECTION).doc('hierarchy').onSnapshot((doc) => {
                unitHierarchy = doc.exists ? doc.data() : {};
                renderHierarchyList(); if(els.unitFilter.value) handleFilterChange();
            });
        }

        function renderTable() {
            els.tableBody.innerHTML = '';
            const totalRows = filteredDocuments.length;
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            if (currentPage > totalPages) currentPage = 1; if (currentPage < 1) currentPage = 1;
            const currentData = filteredDocuments.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);
            renderPaginationControls(totalPages);
            if (totalRows === 0) { els.tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-8 text-gray-500 italic">Không có dữ liệu.</td></tr>`; els.recordCount.innerText = `0 bản ghi`; return; }
            if(isEditMode) els.tableBody.classList.add('editing-mode'); else els.tableBody.classList.remove('editing-mode');

            currentData.forEach(item => {
                const row = document.createElement('tr'); row.className = "hover:bg-blue-50 transition group";
                const safeCode = escapeHtml(item.code || ''), safeName = escapeHtml(item.name || '');
                const safeIssuer = escapeHtml(item.issuer || ''), safeField = escapeHtml(item.field || 'Khác');
                const safeUnit = escapeHtml(item.unit || ''), safeDate = escapeHtml(item.date || '');
                const safeRev = escapeHtml(item.revision || '0');
                const shortIssuer = safeIssuer.length > 6 ? safeIssuer.substring(0, 6) : safeIssuer;
                const scanUrl = String(item.linkScan||'').trim(), softUrl = String(item.linkSoft||'').trim();
                
                const scanTitle = scanUrl.startsWith('http') ? "Tải file Scan thay thế lên Drive" : "Tải file Scan lên Drive";
                const softTitle = softUrl.startsWith('http') ? "Tải file Mềm thay thế lên Drive" : "Tải file Mềm lên Drive";

                let linkScanHtml, linkSoftHtml;
                if (isEditMode) {
                    const scanColor = (scanUrl.startsWith('http')) ? 'text-red-600' : 'text-gray-400';
                    const softColor = (softUrl.startsWith('http')) ? 'text-blue-600' : 'text-gray-400';
                    linkScanHtml = `<button onclick="handleDriveUpload('${item.id}', 'linkScan')" class="btn-upload ${scanColor} hover:text-red-800 transition text-lg" title="${scanTitle}"><i class="fa-solid fa-cloud-arrow-up"></i></button>`;
                    linkSoftHtml = `<button onclick="handleDriveUpload('${item.id}', 'linkSoft')" class="btn-upload ${softColor} hover:text-blue-800 transition text-lg" title="${softTitle}"><i class="fa-solid fa-cloud-arrow-up"></i></button>`;
                } else {
                    linkScanHtml = '<span class="text-gray-200">-</span>'; linkSoftHtml = '<span class="text-gray-200">-</span>';
                    if (scanUrl.startsWith('http')) linkScanHtml = `<a href="${escapeHtml(scanUrl)}" target="_blank" class="text-red-600 hover:text-red-800 text-lg"><i class="fa-solid fa-file-pdf"></i></a>`;
                    if (softUrl.startsWith('http')) linkSoftHtml = `<a href="${escapeHtml(softUrl)}" target="_blank" class="text-blue-600 hover:text-blue-800 text-lg"><i class="fa-solid fa-file-word"></i></a>`;
                }
                const checkboxClass = isEditMode ? "" : "hidden";
                const isChecked = selectedIds.has(item.id) ? "checked" : "";
                const createCell = (field, value, displayValue, extraAttr = '') => { if (!isEditMode) return displayValue; return `<div class="editable-cell" data-id="${item.id}" data-field="${field}" data-val="${escapeHtml(value)}" ${extraAttr} ondblclick="makeEditable(this)">${displayValue}</div>`; };
                row.innerHTML = `<td class="px-2 py-3 text-center align-middle ${checkboxClass}"><input type="checkbox" class="cursor-pointer transform scale-125" value="${item.id}" ${isChecked} onchange="toggleRowSelection('${item.id}')"></td><td class="px-2 py-3 text-sm font-semibold text-gray-700 align-middle break-words">${createCell('code', item.code, safeCode)}</td><td class="px-2 py-3 text-sm text-gray-800 align-middle">${createCell('name', item.name, `<div class="line-clamp-2" title="${safeName}">${safeName}</div>`)}</td><td class="px-2 py-3 text-xs text-center text-gray-500 align-middle relative">${createCell('issuer', item.issuer, `<span class="bg-gray-100 rounded px-1 border" title="${safeIssuer}">${shortIssuer}</span>`, 'data-list="listIssuers"')}</td><td class="px-2 py-3 text-xs text-gray-600 align-middle">${createCell('field', item.field, `<span class="px-2 py-0.5 rounded-full bg-gray-100 border block truncate">${safeField}</span>`, 'data-list="listFields"')}</td><td class="px-2 py-3 text-xs text-gray-600 align-middle">${createCell('unit', item.unit, `<span class="block truncate" title="${safeUnit}">${safeUnit}</span>`, 'data-list="listUnits"')}</td><td class="px-2 py-3 text-xs text-center text-gray-600 align-middle whitespace-nowrap">${createCell('date', item.date, safeDate ? formatDate(safeDate) : '-', 'data-type="date"')}</td><td class="px-2 py-3 text-xs text-center font-bold text-gray-700 align-middle">${createCell('revision', item.revision, safeRev)}</td><td class="px-2 py-3 text-center align-middle">${linkScanHtml}</td><td class="px-2 py-3 text-center align-middle">${linkSoftHtml}</td>`;
                els.tableBody.appendChild(row);
            });
            els.recordCount.innerText = `Hiển thị ${(currentPage-1)*rowsPerPage + 1}-${Math.min(currentPage*rowsPerPage, totalRows)} trong ${totalRows} bản ghi`; 
            if(isEditMode) updateSelectAllState();
        }

        function handleDriveUpload(docId, fieldType) {
            currentUploadContext = { mode: 'inline', docId, fieldType };
            const token = gapi.client.getToken();
            if (!token) { tokenClient.callback = (resp) => { if (resp.error !== undefined) throw (resp); els.driveFileInput.click(); }; tokenClient.requestAccessToken({ prompt: 'consent' }); } 
            else { els.driveFileInput.click(); }
        }

        function handleModalUpload(btn, fieldType) {
            const inputElement = btn.previousElementSibling; currentUploadContext = { mode: 'modal', targetInput: inputElement };
            const token = gapi.client.getToken();
            if (!token) { tokenClient.callback = (resp) => { if (resp.error !== undefined) throw (resp); els.driveFileInput.click(); }; tokenClient.requestAccessToken({ prompt: 'consent' }); } else { els.driveFileInput.click(); }
        }

        async function handleDriveFileSelected(e) {
            const file = e.target.files[0]; if (!file || !currentUploadContext) return; e.target.value = '';
            showNotify(`Đang tải lên ${file.name}...`, 'blue');
            try {
                const metadata = { name: file.name, mimeType: file.type || 'application/octet-stream', parents: [FOLDER_ID] };
                const formData = new FormData(); formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' })); formData.append('file', file);
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` }, body: formData });
                if (!response.ok) throw new Error("Upload thất bại!");
                const fileData = await response.json(); const driveLink = `https://drive.google.com/file/d/${fileData.id}/view`;
                if (currentUploadContext.mode === 'inline') { await db.collection(COLLECTION_NAME).doc(currentUploadContext.docId).update({ [currentUploadContext.fieldType]: driveLink, updatedAt: new Date() }); } 
                else if (currentUploadContext.mode === 'modal') { currentUploadContext.targetInput.value = driveLink; }
                showNotify("Tải lên thành công!", "green");
            } catch (err) { console.error(err); showNotify(`Lỗi tải lên: ${err.message}`, "red"); }
        }

        function makeEditable(element) {
            if (element.querySelector('input')) return;
            const id = element.dataset.id; const field = element.dataset.field; const currentVal = element.dataset.val || ""; const type = element.dataset.type || "text"; const listId = element.dataset.list || "";
            let inputHtml = '';
            if (type === 'date') { inputHtml = `<input type="date" class="inline-input-active" value="${currentVal}" onblur="saveEdit(this, '${id}', '${field}')" onkeydown="if(event.key==='Enter') this.blur()">`; } 
            else { const listAttr = listId ? `list="${listId}"` : ''; const datalistEvents = listId ? `onfocus="handleDatalistFocus(event)"` : ''; inputHtml = `<input type="text" spellcheck="false" class="inline-input-active" value="${escapeHtml(currentVal)}" data-original="${escapeHtml(currentVal)}" ${listAttr} ${datalistEvents} onblur="saveEdit(this, '${id}', '${field}')" onkeydown="if(event.key==='Enter') this.blur()">`; }
            element.innerHTML = inputHtml; const input = element.querySelector('input'); input.focus();
        }
        async function saveEdit(input, id, field) {
            let newValue = input.value.trim();
            if (input.hasAttribute('list') && newValue === '') { const original = input.getAttribute('data-original'); newValue = original || ''; }
            try { const doc = allDocuments.find(d => d.id === id); if (doc && String(doc[field]) !== newValue) { await db.collection(COLLECTION_NAME).doc(id).update({ [field]: newValue, updatedAt: new Date() }); } else { renderTable(); } } catch (e) { console.error(e); showNotify("Lỗi cập nhật!", "red"); renderTable(); }
        }
        function toggleEditMode(enable) {
            isEditMode = enable;
            if (isEditMode) { els.toggleEditBtn.innerHTML = '<i class="fa-solid fa-check mr-1"></i> Xong'; els.toggleEditBtn.className = "bg-gray-600 hover:bg-gray-700 text-white px-4 py-1 rounded text-sm font-bold shadow transition w-24 text-center h-8 whitespace-nowrap"; els.editTools.classList.remove('hidden'); els.colCheckbox.classList.remove('hidden'); }
            else { els.toggleEditBtn.innerHTML = '<i class="fa-solid fa-pen-to-square mr-1"></i> Chỉnh sửa'; els.toggleEditBtn.className = "bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded text-sm font-bold shadow transition w-36 text-center h-8 whitespace-nowrap"; els.editTools.classList.add('hidden'); els.colCheckbox.classList.add('hidden'); selectedIds.clear(); els.selectAll.checked = false; }
            updateAddEditButton(); renderTable();
        }
        function handleFilterChange() {
            const term = els.searchInput.value.toLowerCase(); const field = els.fieldFilter.value; const unit = els.unitFilter.value;
            // [THAY ĐỔI 2: LOGIC LỌC]
            const isStrict = document.getElementById('strictUnitFilter').checked;
            let validUnits = [];
            if (unit) {
                if (isStrict) { validUnits = [unit]; } 
                else { validUnits = [unit, ...getAncestors(unit)]; }
            }
            filteredDocuments = allDocuments.filter(item => {
                const codeStr = String(item.code || '').toLowerCase(); const nameStr = String(item.name || '').toLowerCase();
                const matchesSearch = (codeStr.includes(term) || nameStr.includes(term)); const matchesField = field ? item.field === field : true;
                const matchesUnit = unit ? validUnits.includes(item.unit) : true;
                return matchesSearch && matchesField && matchesUnit;
            });
            if (sortConfig.column) sortData(sortConfig.column); else { currentPage = 1; renderTable(); }
        }
        function getAncestors(targetUnit) { let ancestors = []; for (const [parent, children] of Object.entries(unitHierarchy)) { if (children.includes(targetUnit)) { ancestors.push(parent); ancestors = ancestors.concat(getAncestors(parent)); break; } } return ancestors; }
        function getAllDescendants(root) { let desc = []; const children = unitHierarchy[root] || []; children.forEach(c => { desc.push(c); desc = desc.concat(getAllDescendants(c)); }); return [...new Set(desc)]; }
        function isAncestor(potential, unit) { return getAllDescendants(unit).includes(potential); }
        async function addHierarchyLink() {
            const p = els.hParent.value.trim(), c = els.hChild.value.trim();
            if (!p || !c || p===c) { showNotify("Dữ liệu không hợp lệ!", "red"); return; }
            if (isAncestor(p, c)) { showNotify("Lỗi vòng lặp!", "red"); return; }
            if (!unitHierarchy[p]) unitHierarchy[p] = [];
            if (!unitHierarchy[p].includes(c)) unitHierarchy[p].push(c); else { showNotify("Đã tồn tại!", "blue"); return; }
            await db.collection(SYSTEM_COLLECTION).doc('hierarchy').set(unitHierarchy);
            showNotify("Đã thêm!", "green"); els.hParent.value=''; els.hChild.value=''; renderHierarchyList();
        }
        async function removeHierarchyLink(p, c) { if (!confirm("Xóa liên kết?")) return; if (unitHierarchy[p]) { unitHierarchy[p] = unitHierarchy[p].filter(x => x !== c); if (unitHierarchy[p].length === 0) delete unitHierarchy[p]; await db.collection(SYSTEM_COLLECTION).doc('hierarchy').set(unitHierarchy); renderHierarchyList(); } }
        function renderHierarchyList() { const list = els.hierarchyList; list.innerHTML = ''; if (Object.keys(unitHierarchy).length === 0) { list.innerHTML = '<p class="text-xs text-gray-400 italic text-center">Chưa có phân cấp.</p>'; return; } for (const [p, cs] of Object.entries(unitHierarchy)) { cs.forEach(c => { const d = document.createElement('div'); d.className = "flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100 text-xs"; d.innerHTML = `<div class="flex items-center"><span class="font-bold text-blue-700">${escapeHtml(p)}</span><i class="fa-solid fa-arrow-right mx-2 text-gray-400 text-[10px]"></i><span class="text-gray-700">${escapeHtml(c)}</span></div><button onclick="removeHierarchyLink('${escapeHtml(p)}','${escapeHtml(c)}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-times"></i></button>`; list.appendChild(d); }); } }
        function openHierarchyModal() { document.body.classList.add('modal-active'); els.hierarchyModal.classList.remove('opacity-0', 'pointer-events-none'); renderHierarchyList(); }
        function closeHierarchyModal() { document.body.classList.remove('modal-active'); els.hierarchyModal.classList.add('opacity-0', 'pointer-events-none'); }
        function toggleRowSelection(id) { if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); updateSelectAllState(); updateAddEditButton(); }
        function toggleSelectAll() { const isChecked = els.selectAll.checked; filteredDocuments.forEach(item => { if (isChecked) selectedIds.add(item.id); else selectedIds.delete(item.id); }); updateSelectAllState(); updateAddEditButton(); renderTable(); }
        function updateSelectAllState() { const total = filteredDocuments.length; const selected = selectedIds.size; if (selected > 0 && selected < total) { els.selectAll.indeterminate = true; els.selectAll.checked = false; } else { els.selectAll.indeterminate = false; els.selectAll.checked = (total > 0 && selected === total); } }
        function renderPaginationControls(totalPages) {
            const container = els.paginationContainer; container.innerHTML = ''; if (totalPages <= 1) { container.classList.add('hidden'); return; } container.classList.remove('hidden');
            const getBtnClass = (active) => `px-3 py-1 rounded-md border text-sm font-semibold transition shadow-sm cursor-pointer ${active ? "bg-blue-500 border-blue-500 text-white" : "bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700"}`;
            let pages = []; if (totalPages <= 7) { for (let i = 1; i <= totalPages; i++) pages.push(i); } else { if (currentPage <= 4) pages = [1, 2, 3, 4, 5, '...', totalPages]; else if (currentPage >= totalPages - 3) pages = [1, '...', totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages]; else pages = [1, '...', currentPage - 1, currentPage, currentPage + 1, '...', totalPages]; }
            if (currentPage > 1) { const prev = document.createElement('button'); prev.innerHTML = '<i class="fa-solid fa-chevron-left"></i>'; prev.className = getBtnClass(false); prev.onclick = () => { currentPage--; renderTable(); }; container.appendChild(prev); }
            pages.forEach(p => { const btn = document.createElement('button'); if (p === '...') { btn.innerText = '...'; btn.className = "px-2 py-1 text-gray-500 text-sm cursor-default"; btn.disabled = true; } else { btn.innerText = p; btn.className = getBtnClass(p === currentPage); btn.onclick = () => { currentPage = p; renderTable(); }; } container.appendChild(btn); });
            if (currentPage < totalPages) { const next = document.createElement('button'); next.innerHTML = '<i class="fa-solid fa-chevron-right"></i>'; next.className = getBtnClass(false); next.onclick = () => { currentPage++; renderTable(); }; container.appendChild(next); }
        }
        function setupKeyboardNavigation() { els.modalTableBody.addEventListener('keydown', (e) => { if (e.isComposing || e.keyCode === 229) return; if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter'].includes(e.key)) return; const activeEl = document.activeElement; if (!activeEl || activeEl.tagName !== 'INPUT') return; const currentCell = activeEl.closest('td'); const currentRow = activeEl.closest('tr'); if (!currentCell || !currentRow) return; const cells = Array.from(currentRow.querySelectorAll('td')); const rows = Array.from(els.modalTableBody.querySelectorAll('tr')); const colIndex = cells.indexOf(currentCell); const rowIndex = rows.indexOf(currentRow); if (e.key === 'ArrowDown' || e.key === 'Enter') { if (rowIndex < rows.length - 1) { e.preventDefault(); const target = rows[rowIndex + 1].querySelectorAll('td')[colIndex].querySelector('input'); if(target) {target.focus(); target.select();} } else if (currentModalMode === 'ADD' && e.key === 'Enter') { e.preventDefault(); addNewRow(); setTimeout(() => { const newRows = els.modalTableBody.querySelectorAll('tr'); const target = newRows[newRows.length - 1].querySelectorAll('td')[colIndex].querySelector('input'); if(target) {target.focus(); target.select();} }, 50); } } else if (e.key === 'ArrowUp') { if (rowIndex > 0) { e.preventDefault(); const target = rows[rowIndex - 1].querySelectorAll('td')[colIndex].querySelector('input'); if(target) {target.focus(); target.select();} } } else if (e.key === 'ArrowLeft') { const isText = activeEl.type === 'text' || activeEl.type === 'number'; const isStart = isText ? (activeEl.selectionStart === 0 && activeEl.selectionEnd === 0) : true; if (colIndex > 0 && isStart) { e.preventDefault(); const target = cells[colIndex - 1].querySelector('input'); if(target) {target.focus(); target.select();} } } else if (e.key === 'ArrowRight') { const isText = activeEl.type === 'text' || activeEl.type === 'number'; const isEnd = isText ? (activeEl.selectionStart === activeEl.value.length) : true; if (colIndex < cells.length - 2 && isEnd) { e.preventDefault(); const target = cells[colIndex + 1].querySelector('input'); if(target) {target.focus(); target.select();} } } }); }
        function handleDatalistFocus(e) { e.target.setAttribute('data-original', e.target.value); e.target.value = ''; }
        function handleDatalistBlur(e) { if (e.target.value === '') { const original = e.target.getAttribute('data-original'); if (original) e.target.value = original; } }
        function openModal(mode) { currentModalMode = mode; document.body.classList.add('modal-active'); els.modal.classList.remove('opacity-0', 'pointer-events-none'); els.modalTableBody.innerHTML = ''; if (mode === 'ADD') { els.modalTitle.innerText = "Thêm mới (Batch)"; els.modalSaveBtn.innerHTML = '<i class="fa-solid fa-save mr-1"></i> Lưu toàn bộ'; els.addMoreRowContainer.classList.remove('hidden'); addNewRow(); } else if (mode === 'EDIT') { if (selectedIds.size === 0) { closeModal(); showNotify("Chưa chọn!", "red"); return; } els.modalTitle.innerText = `Cập nhật ${selectedIds.size} tài liệu`; els.modalSaveBtn.innerHTML = '<i class="fa-solid fa-sync mr-1"></i> Cập nhật'; els.addMoreRowContainer.classList.add('hidden'); selectedIds.forEach(id => { const doc = allDocuments.find(d => d.id === id); if (doc) addNewRow(doc); }); } }
        function closeModal() { document.body.classList.remove('modal-active'); els.modal.classList.add('opacity-0', 'pointer-events-none'); }
        function addNewRow(data = null) {
            let defaultIssuer="", defaultField="", defaultUnit=""; if(!data) { const rs = els.modalTableBody.querySelectorAll('tr'); if(rs.length>0) { const last=rs[rs.length-1]; defaultIssuer=last.querySelector('input[name="issuer"]').value; defaultField=last.querySelector('input[name="field"]').value; defaultUnit=last.querySelector('input[name="unit"]').value; } }
            const row = document.createElement('tr'); row.className = "data-row group hover:bg-gray-50"; const val = (k) => data ? escapeHtml(data[k]) : ""; const idVal = data ? data.id : ""; const valIssuer = data ? val('issuer') : defaultIssuer; const valField = data ? val('field') : defaultField; const valUnit = data ? val('unit') : defaultUnit;
            row.innerHTML = `<input type="hidden" name="docId" value="${idVal}"><td class="px-1 py-1"><input type="text" name="code" value="${val('code')}" class="input-mini w-full border rounded focus:ring-1 focus:ring-blue-500" onfocus="this.select()"></td><td class="px-1 py-1"><input type="text" name="name" value="${val('name')}" class="input-mini w-full border rounded focus:ring-1 focus:ring-blue-500 bg-yellow-50 placeholder-gray-300" placeholder="Bắt buộc" onfocus="this.select()"></td><td class="px-1 py-1"><input type="text" name="issuer" value="${valIssuer}" list="listIssuers" class="input-mini w-full border rounded focus:ring-1 focus:ring-blue-500 cursor-pointer" onfocus="handleDatalistFocus(event)" onblur="handleDatalistBlur(event)"></td><td class="px-1 py-1"><input type="text" name="field" value="${valField}" list="listFields" class="input-mini w-full border rounded focus:ring-1 focus:ring-blue-500 cursor-pointer" onfocus="handleDatalistFocus(event)" onblur="handleDatalistBlur(event)"></td><td class="px-1 py-1"><input type="text" name="unit" value="${valUnit}" list="listUnits" class="input-mini w-full border rounded focus:ring-1 focus:ring-blue-500 cursor-pointer" onfocus="handleDatalistFocus(event)" onblur="handleDatalistBlur(event)"></td><td class="px-1 py-1"><input type="date" name="date" value="${data ? data.date : ''}" class="input-mini w-full border rounded focus:ring-1 focus:ring-blue-500 text-xs" onfocus="this.select()"></td><td class="px-1 py-1"><input type="text" name="revision" value="${val('revision')}" class="input-mini w-full border rounded focus:ring-1 focus:ring-blue-500" onfocus="this.select()"></td><td class="px-1 py-1"><div class="flex items-center space-x-1"><input type="text" name="linkScan" value="${val('linkScan')}" class="input-mini w-full border rounded focus:ring-1 focus:ring-blue-500 text-xs placeholder-gray-300" onfocus="this.select()"><button type="button" onclick="handleModalUpload(this, 'linkScan')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-cloud-arrow-up"></i></button></div></td><td class="px-1 py-1"><div class="flex items-center space-x-1"><input type="text" name="linkSoft" value="${val('linkSoft')}" class="input-mini w-full border rounded focus:ring-1 focus:ring-blue-500 text-xs placeholder-gray-300" onfocus="this.select()"><button type="button" onclick="handleModalUpload(this, 'linkSoft')" class="text-blue-500 hover:text-blue-700"><i class="fa-solid fa-cloud-arrow-up"></i></button></div></td><td class="px-1 py-1 text-center"><button onclick="this.closest('tr').remove()" class="text-gray-400 hover:text-red-500 transition" tabindex="-1"><i class="fa-solid fa-trash-can"></i></button></td>`;
            els.modalTableBody.appendChild(row);
        }
        async function handleModalSave() { const rows = els.modalTableBody.querySelectorAll('.data-row'); if (rows.length === 0) return; const batch = db.batch(); let count = 0; const now = new Date(); rows.forEach(row => { const name = row.querySelector('input[name="name"]').value.trim(); if (!name) return; const docId = row.querySelector('input[name="docId"]').value; const dd = { code: row.querySelector('input[name="code"]').value.trim(), name, issuer: row.querySelector('input[name="issuer"]').value.trim(), field: row.querySelector('input[name="field"]').value.trim(), unit: row.querySelector('input[name="unit"]').value.trim(), date: row.querySelector('input[name="date"]').value, revision: row.querySelector('input[name="revision"]').value.trim(), linkScan: row.querySelector('input[name="linkScan"]').value.trim(), linkSoft: row.querySelector('input[name="linkSoft"]').value.trim(), updatedAt: now }; if (currentModalMode === 'EDIT' && docId) batch.update(db.collection(COLLECTION_NAME).doc(docId), dd); else { dd.createdAt = now; batch.set(db.collection(COLLECTION_NAME).doc(), dd); } count++; }); if (count === 0) { showNotify("Thiếu tên!", "red"); return; } try { showNotify("Đang lưu...", "blue"); await batch.commit(); closeModal(); showNotify("Thành công!", "green"); if (currentModalMode === 'EDIT') { selectedIds.clear(); els.selectAll.checked = false; } } catch (e) { console.error(e); showNotify("Lỗi!", "red"); } }
        async function deleteSelected() { if (selectedIds.size === 0) { showNotify("Chưa chọn!", "red"); return; } if (!confirm(`Xóa ${selectedIds.size} dòng?`)) return; const batch = db.batch(); selectedIds.forEach(id => batch.delete(db.collection(COLLECTION_NAME).doc(id))); try { await batch.commit(); showNotify("Đã xóa.", "green"); selectedIds.clear(); els.selectAll.checked = false; renderTable(); } catch (e) { console.error(e); showNotify("Lỗi!", "red"); } }
        function updateDatalists() { els.listFields.innerHTML=''; els.listUnits.innerHTML=''; els.listIssuers.innerHTML=''; [...new Set(allDocuments.map(i=>i.field).filter(Boolean))].sort().forEach(f=>els.listFields.appendChild(new Option(f,f))); [...new Set(allDocuments.map(i=>i.unit).filter(Boolean))].sort().forEach(u=>els.listUnits.appendChild(new Option(u,u))); [...new Set(allDocuments.map(i=>i.issuer).filter(Boolean))].sort().forEach(i=>els.listIssuers.appendChild(new Option(i,i))); }
        function populateFilters() { const fV=els.fieldFilter.value, uV=els.unitFilter.value; els.fieldFilter.innerHTML='<option value="">Tất cả</option>'; els.unitFilter.innerHTML='<option value="">Tất cả</option>'; [...new Set(allDocuments.map(i=>i.field).filter(Boolean))].sort().forEach(f=>els.fieldFilter.add(new Option(f,f))); [...new Set(allDocuments.map(i=>i.unit).filter(Boolean))].sort().forEach(u=>els.unitFilter.add(new Option(u,u))); els.fieldFilter.value=fV; els.unitFilter.value=uV; }
        function escapeHtml(t) { return t == null ? "" : t.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
        function formatDate(s) { if (!s) return ''; try { const d = new Date(s); return isNaN(d) ? s : `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`; } catch { return s; } }
        function showNotify(m, c) { els.notification.className = `mb-3 p-3 rounded text-sm font-medium flex-none text-center shadow-sm bg-${c}-100 text-${c}-800 border border-${c}-300`; els.notification.innerHTML = m; els.notification.classList.remove('hidden'); setTimeout(()=>els.notification.classList.add('hidden'), 5000); }
        async function handleExcelUpload(e) { const f = e.target.files[0]; if(!f) return; e.target.value=''; showNotify("Đang đọc...","blue"); const r = new FileReader(); r.onload=async e=>{ try { const d = new Uint8Array(e.target.result); const wb = XLSX.read(d,{type:'array'}); await processImport(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]])); } catch(err){ console.error(err); showNotify("Lỗi file!", "red"); } }; r.readAsArrayBuffer(f); }
        async function processImport(d) { let u=0,a=0; const total=d.length; showNotify(`Xử lý ${total} dòng...`,"blue"); const m = new Map(); allDocuments.forEach(doc=>{if(doc.code) m.set(String(doc.code).trim(),doc.id)}); const limit=400; let b=db.batch(), ops=0; for(const r of d) { const c=String(r['Mã hiệu']||'').trim(), n=String(r['Tên tài liệu']||'').trim(); if(!c && !n) continue; const dd={ code:c, name:n, issuer:r['Cơ quan ban hành']||'', field:r['Lĩnh vực']||'', unit:r['Đơn vị thực hiện']||'', date:r['Ngày ban hành'] ? new Date(Math.round((r['Ngày ban hành']-25569)*86400*1000)).toISOString().split('T')[0] : '', revision:r['Lần ban hành']||'', linkScan:r['Đường dẫn (bản scan)']||'', linkSoft:r['Đường dẫn (bản mềm)']||'', updatedAt:new Date() }; if(c && m.has(c)) { b.update(db.collection(COLLECTION_NAME).doc(m.get(c)), dd); u++; } else { dd.createdAt=new Date(); b.set(db.collection(COLLECTION_NAME).doc(), dd); a++; } ops++; if(ops>=limit) { await b.commit(); b=db.batch(); ops=0; } } if(ops>0) await b.commit(); showNotify(`Thêm: ${a}, Cập nhật: ${u}`, "green"); }
    </script>
</body>
</html>
